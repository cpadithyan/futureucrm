<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FutureU Tele CRM - AI Enterprise</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .sidebar-active { background: rgba(59, 130, 246, 0.1); border-left: 4px solid #3b82f6; color: #3b82f6; }
        .hidden { display: none; }
        .modal-bg { background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(6px); }
        
        @media (max-width: 768px) {
            .hide-mobile { display: none; }
        }

        .fade-in { animation: fadeIn 0.2s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        #leads-container > div { transition: all 0.2s ease; }
        #processing-overlay { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(8px); }
        
        .scroll-container { -webkit-overflow-scrolling: touch; will-change: scroll-position; }
        
        /* Tooltip style for AI */
        .ai-glow { box-shadow: 0 0 15px rgba(59, 130, 246, 0.3); border: 1px solid rgba(59, 130, 246, 0.5); }
    </style>
</head>
<body class="bg-gray-50 min-h-screen text-gray-800">

    <!-- Global Processing Overlay -->
    <div id="processing-overlay" class="fixed inset-0 z-[200] hidden flex flex-col items-center justify-center">
        <div class="loader w-12 h-12 border-4 mb-4"></div>
        <p id="processing-text" class="font-bold text-blue-600 animate-pulse">Syncing Database...</p>
    </div>

    <!-- Auth Overlay -->
    <div id="auth-overlay" class="fixed inset-0 z-[100] flex items-center justify-center bg-blue-600 px-4">
        <div class="bg-white p-8 rounded-3xl shadow-2xl w-full max-w-md">
            <div class="text-center mb-8">
                <div class="w-20 h-20 bg-blue-100 text-blue-600 rounded-3xl flex items-center justify-center text-4xl mx-auto mb-4">
                    <i class="fas fa-rocket"></i>
                </div>
                <h1 class="text-2xl font-bold text-gray-900">FutureU Tele CRM</h1>
                <p class="text-gray-500 text-sm mt-1">AI-Powered Lead Management</p>
            </div>
            <div class="space-y-4">
                <div id="login-error" class="hidden p-3 bg-red-50 text-red-600 text-xs rounded-xl text-center font-bold"></div>
                <div>
                    <label class="block text-[10px] font-bold text-gray-400 uppercase mb-2">Employee ID</label>
                    <input type="text" id="login-id" class="w-full p-4 bg-gray-50 border rounded-2xl outline-none focus:ring-2 ring-blue-500 transition" placeholder="e.g. EMP101">
                </div>
                <div>
                    <label class="block text-[10px] font-bold text-gray-400 uppercase mb-2">Password</label>
                    <input type="password" id="login-pass" class="w-full p-4 bg-gray-50 border rounded-2xl outline-none focus:ring-2 ring-blue-500 transition" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                </div>
                <button onclick="handleLogin()" id="login-btn" class="w-full bg-blue-600 text-white py-4 rounded-2xl font-bold hover:bg-blue-700 transition shadow-lg flex justify-center items-center gap-2">
                    Verify & Login
               
        </div>
    </div>

    <!-- Mobile Top Bar -->
    <header class="md:hidden bg-white border-b px-4 py-4 sticky top-0 z-40 flex justify-between items-center">
        <h2 class="font-bold text-blue-600 flex items-center gap-2">
            <i class="fas fa-phone-alt"></i> FutureU CRM
        </h2>
        <button onclick="toggleMobileMenu()" class="w-10 h-10 flex items-center justify-center bg-gray-50 rounded-xl">
            <i class="fas fa-bars text-gray-600" id="menu-icon"></i>
        </button>
    </header>

    <div id="app-container" class="hidden flex h-screen overflow-hidden">
        
        <!-- Sidebar -->
        <aside id="sidebar" class="fixed inset-y-0 left-0 z-50 w-64 bg-white border-r flex flex-col transform -translate-x-full transition-transform md:relative md:translate-x-0">
            <div class="p-6 border-b hide-mobile">
                <h2 class="text-xl font-bold text-blue-600 flex items-center gap-2">
                    <i class="fas fa-rocket"></i> FutureU Console
                </h2>
            </div>
            <nav class="flex-1 p-4 space-y-2 overflow-y-auto scroll-container">
                <button onclick="showView('dashboard')" class="sidebar-btn w-full flex items-center gap-3 p-4 rounded-2xl transition" id="btn-dashboard">
                    <i class="fas fa-chart-line"></i> Dashboard
                </button>
                <button onclick="showView('leads')" class="sidebar-btn w-full flex items-center gap-3 p-4 rounded-2xl transition" id="btn-leads">
                    <i class="fas fa-users"></i> Lead Bucket
                </button>
                <button onclick="showView('lists')" class="sidebar-btn w-full flex items-center gap-3 p-4 rounded-2xl transition admin-only" id="btn-lists">
                    <i class="fas fa-layer-group"></i> Lead Lists
                </button>
                <button onclick="showView('staff')" class="sidebar-btn w-full flex items-center gap-3 p-4 rounded-2xl transition admin-only" id="btn-staff">
                    <i class="fas fa-user-friends"></i> Manage Staff
                </button>
            </nav>
            <div class="p-4 border-t">
                <div class="flex items-center gap-3 mb-4 p-3 bg-gray-50 rounded-2xl">
                    <div class="w-10 h-10 rounded-full bg-blue-600 flex items-center justify-center text-white font-bold" id="user-avatar">?</div>
                    <div class="truncate">
                        <p class="text-sm font-bold truncate" id="user-name">User</p>
                        <p class="text-[10px] text-gray-400 font-bold uppercase tracking-wider" id="user-role-label">Role</p>
                    </div>
                </div>
                <button onclick="logout()" class="w-full flex items-center gap-3 p-3 text-red-500 rounded-xl hover:bg-red-50 transition font-medium">
                    <i class="fas fa-power-off"></i> Logout
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto bg-gray-50 pb-24 md:pb-8 scroll-container">
            <div class="p-4 md:p-8 max-w-6xl mx-auto space-y-6">
                
                <!-- Dashboard View -->
                <section id="view-dashboard" class="view space-y-6 fade-in">
                    <h1 class="text-2xl font-bold">Analytics Overview</h1>
                    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
                        <div class="bg-white p-6 rounded-3xl border shadow-sm">
                            <p class="text-gray-400 text-[10px] font-bold uppercase">Total Leads</p>
                            <h3 class="text-3xl font-bold mt-1" id="stat-total">0</h3>
                        </div>
                        <div class="bg-white p-6 rounded-3xl border shadow-sm text-green-600">
                            <p class="text-gray-400 text-[10px] font-bold uppercase">Converted</p>
                            <h3 class="text-3xl font-bold mt-1" id="stat-converted">0</h3>
                        </div>
                        <div class="bg-white p-6 rounded-3xl border shadow-sm text-orange-500">
                            <p class="text-gray-400 text-[10px] font-bold uppercase">Follow-ups</p>
                            <h3 class="text-3xl font-bold mt-1" id="stat-pending">0</h3>
                        </div>
                        <div class="bg-white p-6 rounded-3xl border shadow-sm text-red-500">
                            <p class="text-gray-400 text-[10px] font-bold uppercase">Rejected</p>
                            <h3 class="text-3xl font-bold mt-1" id="stat-rejected">0</h3>
                        </div>
                    </div>
                    <div class="bg-white p-8 rounded-[2.5rem] border shadow-sm h-80">
                        <canvas id="analyticsChart"></canvas>
                    </div>
                </section>

                <!-- Leads View -->
                <section id="view-leads" class="view hidden space-y-4 fade-in">
                    <div class="flex justify-between items-center">
                        <h1 class="text-2xl font-bold">Leads Bucket</h1>
                        <div class="flex gap-2">
                             <button onclick="exportCurrentLeads()" class="bg-green-50 text-green-600 px-4 py-3 rounded-2xl font-bold border border-green-100 flex items-center gap-2 active:scale-95 transition">
                                <i class="fas fa-file-excel"></i> <span class="hide-mobile">Export</span>
                            </button>
                            <button onclick="openLeadModal()" class="bg-blue-600 text-white px-6 py-3 rounded-2xl font-bold shadow-lg shadow-blue-100 flex items-center gap-2 active:scale-95 transition">
                                <i class="fas fa-plus"></i> <span class="hide-mobile">New Lead</span>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Advanced Filters -->
                    <div class="bg-white p-4 rounded-2xl border grid grid-cols-1 md:grid-cols-4 gap-3">
                        <div class="md:col-span-2 relative">
                            <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
                            <input type="text" id="search-input" oninput="debouncedRenderLeads()" class="w-full pl-12 pr-4 py-3 bg-gray-50 rounded-xl outline-none" placeholder="Search name or phone...">
                        </div>
                        <select id="filter-status" onchange="debouncedRenderLeads()" class="p-3 bg-gray-50 rounded-xl outline-none font-bold text-sm">
                            <option value="all">All Status</option>
                            <option value="new">üÜï New</option>
                            <option value="follow-up">‚è≥ Follow-up</option>
                            <option value="converted">‚úÖ Converted</option>
                            <option value="rejected">‚ùå Rejected</option>
                        </select>
                        <select id="sort-order" onchange="debouncedRenderLeads()" class="p-3 bg-gray-50 rounded-xl outline-none font-bold text-sm">
                            <option value="newest">Latest First</option>
                            <option value="oldest">Oldest First</option>
                            <option value="name">Name (A-Z)</option>
                            <option value="followup">Follow-up Due</option>
                        </select>
                        <select id="filter-list" onchange="debouncedRenderLeads()" class="p-3 bg-gray-50 rounded-xl outline-none font-bold text-sm md:col-span-1">
                            <option value="all">All Lists</option>
                        </select>
                    </div>

                    <div id="leads-container" class="space-y-4"></div>
                    <div id="load-more-btn" class="hidden text-center py-4">
                        <button onclick="loadMoreLeads()" class="bg-gray-200 text-gray-700 px-8 py-3 rounded-2xl font-bold hover:bg-gray-300 transition">Load More Results</button>
                    </div>
                </section>

                <!-- Lists Management View -->
                <section id="view-lists" class="view hidden space-y-6 fade-in">
                    <div class="flex justify-between items-center">
                        <h1 class="text-2xl font-bold">Lead Lists</h1>
                        <button onclick="document.getElementById('excel-input').click()" class="bg-blue-600 text-white px-6 py-3 rounded-2xl font-bold flex items-center gap-2 active:scale-95 transition">
                            <i class="fas fa-upload"></i> Upload New List
                        </button>
                        <input type="file" id="excel-input" class="hidden" accept=".xlsx,.xls,.csv" onchange="handleExcelUpload(event)">
                    </div>
                    <div id="lists-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                </section>

                <!-- Staff Management View -->
                <section id="view-staff" class="view hidden space-y-6 fade-in">
                    <div class="flex justify-between items-center">
                        <h1 class="text-2xl font-bold">Employee Directory</h1>
                        <button onclick="openStaffModal()" class="bg-gray-900 text-white px-6 py-3 rounded-2xl font-bold shadow-lg active:scale-95 transition">
                            <i class="fas fa-user-plus"></i> Create Employee
                        </button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="staff-container"></div>
                </section>

            </div>
        </main>
    </div>

    <!-- Modals -->
    <!-- AI Script Modal -->
    <div id="ai-modal" class="fixed inset-0 z-[120] hidden flex items-center justify-center p-4 modal-bg">
        <div class="bg-white rounded-[2rem] w-full max-w-lg shadow-2xl overflow-hidden p-8 space-y-6 ai-glow">
            <div class="flex justify-between items-center">
                <h3 class="text-xl font-bold text-blue-600 flex items-center gap-2">
                    <i class="fas fa-magic"></i> FutureU AI Pitch
                </h3>
                <button onclick="document.getElementById('ai-modal').classList.add('hidden')" class="text-gray-400 hover:text-gray-600"><i class="fas fa-times"></i></button>
            </div>
            <div id="ai-content" class="bg-blue-50 p-6 rounded-2xl text-blue-900 leading-relaxed italic border border-blue-100 min-h-[100px] flex items-center justify-center">
                <div class="loader w-6 h-6 border-2 border-blue-600 border-t-transparent"></div>
            </div>
            <p class="text-[10px] text-gray-400 uppercase font-bold text-center">AI generated based on current lead notes</p>
            <button onclick="copyToClipboard(document.getElementById('ai-content').innerText)" class="w-full py-4 bg-blue-600 text-white rounded-2xl font-bold shadow-lg">Copy to Clipboard</button>
        </div>
    </div>

    <!-- Staff Modal -->
    <div id="staff-modal" class="fixed inset-0 z-[110] hidden flex items-center justify-center p-4 modal-bg">
        <div class="bg-white rounded-[2rem] w-full max-w-md shadow-2xl overflow-hidden p-8 space-y-6">
            <h3 class="text-xl font-bold">Employee Account</h3>
            <div class="space-y-4">
                <input type="text" id="staff-name" placeholder="Full Name" class="w-full p-4 bg-gray-50 rounded-2xl outline-none border">
                <input type="text" id="staff-id" placeholder="Employee ID (Login ID)" class="w-full p-4 bg-gray-50 rounded-2xl outline-none border">
                <input type="text" id="staff-pass" placeholder="Password" class="w-full p-4 bg-gray-50 rounded-2xl outline-none border">
            </div>
            <div class="flex gap-3">
                <button onclick="closeStaffModal()" class="flex-1 py-4 text-gray-400 font-bold">Cancel</button>
                <button onclick="saveEmployee()" class="flex-1 py-4 bg-blue-600 text-white rounded-2xl font-bold">Save Account</button>
            </div>
        </div>
    </div>

    <!-- Lead Modal -->
    <div id="lead-modal" class="fixed inset-0 z-[110] hidden flex items-center justify-center p-4 modal-bg">
        <div class="bg-white rounded-[2rem] w-full max-w-md shadow-2xl overflow-hidden p-8 space-y-6">
            <h3 class="text-xl font-bold" id="lead-modal-title">Lead Info</h3>
            <div class="space-y-4">
                <input type="text" id="lead-name" placeholder="Candidate Name" class="w-full p-4 bg-gray-50 rounded-2xl outline-none border">
                <input type="tel" id="lead-phone" placeholder="Phone Number" class="w-full p-4 bg-gray-50 rounded-2xl outline-none border">
                <div>
                    <label class="text-[10px] font-bold text-gray-400 uppercase ml-2 mb-1 block">Next Follow-up Date</label>
                    <input type="date" id="lead-followup" class="w-full p-4 bg-gray-50 rounded-2xl outline-none border text-sm">
                </div>
                <textarea id="lead-notes" rows="3" placeholder="Notes & History..." class="w-full p-4 bg-gray-50 rounded-2xl outline-none border"></textarea>
            </div>
            <div class="flex gap-3">
                <button onclick="closeLeadModal()" class="flex-1 py-4 text-gray-400 font-bold">Cancel</button>
                <button onclick="saveLead()" class="flex-1 py-4 bg-blue-600 text-white rounded-2xl font-bold">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed bottom-8 left-1/2 -translate-x-1/2 md:left-auto md:right-8 md:translate-x-0 translate-y-20 opacity-0 transition-all duration-300 bg-gray-900 text-white px-6 py-4 rounded-2xl shadow-2xl z-[150]">
        <span id="toast-msg">Success</span>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, query, onSnapshot, updateDoc, deleteDoc, addDoc, Timestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyAraa3TDkLEs0tj0REa918PjlD_GAuHL0c",
            authDomain: "telecrm-c0cd8.firebaseapp.com",
            projectId: "telecrm-c0cd8",
            storageBucket: "telecrm-c0cd8.firebasestorage.app",
            messagingSenderId: "958261959120",
            appId: "1:958261959120:web:7938f2e4dedcbffc0bc1d5"
        };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'telecrm-c0cd8';
        const apiKey = ""; // Set by environment

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // State Management
        let user = null;
        let leads = [];
        let staff = [];
        let leadLists = [];
        let myChart = null;
        let editingLeadId = null;
        let isProcessing = false;
        let currentRenderLimit = 50;
        let renderTimeout = null;

        // --- AUTH ---
        const initAuth = async () => {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                await signInAnonymously(auth);
            }
        };

        onAuthStateChanged(auth, (u) => {
            user = u;
            const session = localStorage.getItem('crm_session_v2');
            if (session && u) {
                window.currentUser = JSON.parse(session);
                setupApp();
            }
        });

        window.handleLogin = async () => {
            const id = document.getElementById('login-id').value.trim();
            const pass = document.getElementById('login-pass').value.trim();
            const errorEl = document.getElementById('login-error');

            if (!id || !pass) return;
            if (id === 'admin_01' && pass === 'admin@123') {
                proceedLogin({ id, name: 'Principal Admin', role: 'admin' });
                return;
            }

            try {
                const userRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', id);
                const userSnap = await getDoc(userRef);
                if (userSnap.exists() && userSnap.data().password === pass) {
                    proceedLogin({ id, name: userSnap.data().name, role: 'telecaller' });
                } else {
                    errorEl.innerText = "Invalid ID or Password";
                    errorEl.classList.remove('hidden');
                }
            } catch (err) {
                errorEl.innerText = "Connection error.";
                errorEl.classList.remove('hidden');
            }
        };

        function proceedLogin(userData) {
            window.currentUser = userData;
            localStorage.setItem('crm_session_v2', JSON.stringify(userData));
            if (!user) initAuth(); else setupApp();
        }

        window.logout = () => { localStorage.removeItem('crm_session_v2'); location.reload(); };

        // --- APP LOGIC ---
        function setupApp() {
            if (!user) return;
            document.getElementById('auth-overlay').classList.add('hidden');
            document.getElementById('app-container').classList.remove('hidden');
            document.getElementById('user-name').innerText = window.currentUser.name;
            document.getElementById('user-role-label').innerText = window.currentUser.role;
            document.getElementById('user-avatar').innerText = window.currentUser.name.charAt(0);

            if (window.currentUser.role !== 'admin') document.querySelectorAll('.admin-only').forEach(e => e.remove());

            // Incremental Listener for Leads
            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'leads'), (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    const data = { id: change.doc.id, ...change.doc.data() };
                    if (change.type === "added") leads.push(data);
                    if (change.type === "modified") {
                        const index = leads.findIndex(l => l.id === data.id);
                        if (index !== -1) leads[index] = data;
                    }
                    if (change.type === "removed") leads = leads.filter(l => l.id !== data.id);
                });
                debouncedRenderLeads();
            });

            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'users'), (snap) => {
                staff = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                if (window.currentUser.role === 'admin' && !isProcessing) renderStaff();
            });

            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'lead_groups'), (snap) => {
                leadLists = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                updateListFilters();
                if(window.currentUser.role === 'admin' && !isProcessing) renderLists();
            });

            showView('leads');
        }

        window.showView = (name) => {
            document.querySelectorAll('.view').forEach(v => v.classList.add('hidden'));
            document.getElementById('view-' + name).classList.remove('hidden');
            document.querySelectorAll('.sidebar-btn').forEach(b => b.classList.remove('sidebar-active'));
            document.getElementById('btn-' + name).classList.add('sidebar-active');
            if (name === 'dashboard') updateChart();
            if (window.innerWidth < 768) toggleMobileMenu(false);
            if (name === 'leads') debouncedRenderLeads();
        };

        function updateListFilters() {
            const filterSelect = document.getElementById('filter-list');
            if(!filterSelect) return;
            const currentVal = filterSelect.value;
            let optionsHtml = '<option value="all">All Lists</option>';
            const visibleLists = window.currentUser.role === 'admin' ? leadLists : leadLists.filter(gl => leads.some(l => l.listId === gl.id && l.assignedTo === window.currentUser.id));
            optionsHtml += visibleLists.map(gl => `<option value="${gl.id}">${gl.name}</option>`).join('');
            filterSelect.innerHTML = optionsHtml;
            filterSelect.value = currentVal;
        }

        // --- GEMINI AI ASSISTANT ---
        window.getAIPitch = async (id) => {
            const l = leads.find(x => x.id === id);
            if (!l) return;

            const modal = document.getElementById('ai-modal');
            const content = document.getElementById('ai-content');
            modal.classList.remove('hidden');
            content.innerHTML = '<div class="loader w-6 h-6 border-2 border-blue-600 border-t-transparent"></div>';

            const systemPrompt = "You are a helpful telecalling assistant for FutureU Institute. Generate a personalized 3-sentence script to talk to the lead based on their name and provided notes. Keep it concise, friendly, and persuasive.";
            const userQuery = `Lead Name: ${l.name}. Lead Notes: ${l.notes || 'Interested in courses'}.`;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: userQuery }] }],
                        systemInstruction: { parts: [{ text: systemPrompt }] }
                    })
                });

                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text || "I couldn't generate a script at the moment. Try again.";
                content.innerText = text;
            } catch (err) {
                content.innerText = "Error generating AI script. Please check your connection.";
            }
        };

        // --- RENDERING ---
        window.debouncedRenderLeads = () => {
            if (renderTimeout) clearTimeout(renderTimeout);
            renderTimeout = setTimeout(() => {
                if (!isProcessing) {
                    renderLeads();
                    updateStats();
                    updateChart();
                }
            }, 150);
        };

        window.renderLeads = () => {
            const container = document.getElementById('leads-container');
            if (!container) return;

            const statusFilter = document.getElementById('filter-status').value;
            const listFilter = document.getElementById('filter-list').value;
            const sortOrder = document.getElementById('sort-order').value;
            const searchQuery = (document.getElementById('search-input')?.value || "").toLowerCase();

            let filtered = [...leads];
            if (window.currentUser.role !== 'admin') filtered = filtered.filter(l => l.assignedTo === window.currentUser.id);
            if (statusFilter !== 'all') filtered = filtered.filter(l => l.status === statusFilter);
            if (listFilter !== 'all') filtered = filtered.filter(l => l.listId === listFilter);
            if (searchQuery) filtered = filtered.filter(l => (l.name && l.name.toLowerCase().includes(searchQuery)) || (l.phone && l.phone.includes(searchQuery)));

            // Advanced Sort
            if (sortOrder === 'newest') filtered.sort((a,b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
            if (sortOrder === 'oldest') filtered.sort((a,b) => (a.createdAt?.seconds || 0) - (b.createdAt?.seconds || 0));
            if (sortOrder === 'name') filtered.sort((a,b) => (a.name || "").localeCompare(b.name || ""));
            if (sortOrder === 'followup') filtered.sort((a,b) => (new Date(a.followup || "9999-12-31")) - (new Date(b.followup || "9999-12-31")));

            const today = new Date().toISOString().split('T')[0];
            const totalFiltered = filtered.length;
            const displaySubset = filtered.slice(0, currentRenderLimit);

            const fragment = document.createDocumentFragment();
            displaySubset.forEach(l => {
                const listName = leadLists.find(gl => gl.id === l.listId)?.name || 'Manual';
                const isDue = l.followup && l.followup <= today && l.status !== 'converted' && l.status !== 'rejected';
                
                const card = document.createElement('div');
                card.className = `bg-white p-5 rounded-3xl border shadow-sm space-y-4 fade-in ${isDue ? 'border-orange-200 bg-orange-50/20' : ''}`;
                card.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <h3 class="text-lg font-bold cursor-pointer hover:text-blue-600 flex items-center gap-2" onclick="window.inlineEdit('${l.id}', 'name')">
                                ${l.name || '<span class="text-gray-300">No Name</span>'}
                                ${isDue ? '<span class="text-[8px] bg-orange-500 text-white px-1.5 py-0.5 rounded-full uppercase tracking-tighter">Follow-up Due</span>' : ''}
                            </h3>
                            <p class="text-sm font-mono text-gray-500">${l.phone}</p>
                            <div class="flex gap-1 mt-1">
                                <span class="text-[9px] bg-blue-50 text-blue-600 px-2 py-0.5 rounded font-bold uppercase tracking-tighter">${listName}</span>
                                ${l.followup ? `<span class="text-[9px] bg-gray-100 text-gray-600 px-2 py-0.5 rounded font-bold uppercase">üìÖ ${l.followup}</span>` : ''}
                            </div>
                        </div>
                        <div class="flex flex-col items-end gap-2">
                             <button onclick="window.getAIPitch('${l.id}')" class="text-blue-500 bg-blue-50 w-8 h-8 rounded-full flex items-center justify-center hover:bg-blue-100 transition" title="AI Calling Script">
                                <i class="fas fa-magic text-xs"></i>
                            </button>
                            <select onchange="window.updateStatus('${l.id}', this.value)" class="text-[10px] font-bold px-3 py-1 rounded-xl border-none outline-none ${getStatusStyle(l.status)}">
                                <option value="new" ${l.status === 'new' ? 'selected' : ''}>NEW</option>
                                <option value="follow-up" ${l.status === 'follow-up' ? 'selected' : ''}>FOLLOW-UP</option>
                                <option value="converted" ${l.status === 'converted' ? 'selected' : ''}>CONVERTED</option>
                                <option value="rejected" ${l.status === 'rejected' ? 'selected' : ''}>REJECTED</option>
                            </select>
                        </div>
                    </div>
                    <div class="grid grid-cols-4 gap-2">
                        <a href="tel:${l.phone}" class="col-span-2 bg-blue-600 text-white h-14 rounded-2xl flex items-center justify-center gap-2 font-bold shadow-lg active:scale-95 transition">
                            <i class="fas fa-phone-alt"></i> CALL
                        </a>
                        <button onclick="window.openWA('${l.id}')" class="bg-green-100 text-green-600 rounded-2xl flex items-center justify-center active:scale-95 transition"><i class="fab fa-whatsapp text-2xl"></i></button>
                        <button onclick="window.shareLead('${l.id}')" class="bg-gray-100 text-gray-500 rounded-2xl flex items-center justify-center active:scale-95 transition"><i class="fas fa-share-alt"></i></button>
                    </div>
                    <div class="text-[10px] text-gray-400 flex justify-between border-t pt-3 font-bold uppercase">
                        <span>Updated: ${l.updatedAt?.toDate().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) || '--'}</span>
                        <div class="flex gap-4">
                            <button onclick="window.openLeadModal('${l.id}')" class="text-blue-500 font-bold">EDIT</button>
                            ${window.currentUser.role === 'admin' ? `<button onclick="window.deleteLead('${l.id}')" class="text-red-400 font-bold">DELETE</button>` : ''}
                        </div>
                    </div>
                `;
                fragment.appendChild(card);
            });

            container.innerHTML = "";
            container.appendChild(fragment);

            const loadMoreBtn = document.getElementById('load-more-btn');
            if (totalFiltered > currentRenderLimit) loadMoreBtn.classList.remove('hidden'); else loadMoreBtn.classList.add('hidden');
            if (totalFiltered === 0) container.innerHTML = `<div class="py-20 text-center text-gray-400 italic">No leads found.</div>`;
        };

        window.loadMoreLeads = () => { currentRenderLimit += 50; renderLeads(); };

        window.exportCurrentLeads = () => {
            const statusFilter = document.getElementById('filter-status').value;
            const listFilter = document.getElementById('filter-list').value;
            let exportData = leads;
            if (window.currentUser.role !== 'admin') exportData = leads.filter(l => l.assignedTo === window.currentUser.id);
            if (statusFilter !== 'all') exportData = exportData.filter(l => l.status === statusFilter);
            if (listFilter !== 'all') exportData = exportData.filter(l => l.listId === listFilter);

            const worksheet = XLSX.utils.json_to_sheet(exportData.map(l => ({ Name: l.name, Phone: l.phone, Status: l.status, Notes: l.notes || "", Date: l.createdAt?.toDate().toLocaleDateString() })));
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Leads");
            XLSX.writeFile(workbook, `FutureU_CRM_Export_${new Date().toISOString().split('T')[0]}.xlsx`);
        };

        // --- STAFF & LIST RENDERING ---
        function renderLists() {
            const container = document.getElementById('lists-container');
            if(!container) return;
            container.innerHTML = leadLists.map(list => {
                const listLeads = leads.filter(l => l.listId === list.id);
                const assignedTelecallerId = listLeads.length > 0 ? listLeads[0].assignedTo : '';
                return `
                    <div class="bg-white p-6 rounded-3xl border shadow-sm space-y-4 fade-in">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <h4 class="font-bold text-lg cursor-pointer hover:text-blue-600" onclick="renameList('${list.id}')">${list.name}</h4>
                                <p class="text-xs text-gray-400 uppercase font-bold">${listLeads.length} Leads</p>
                            </div>
                            <button onclick="deleteList('${list.id}')" class="text-red-300 hover:text-red-500"><i class="fas fa-trash"></i></button>
                        </div>
                        <div class="space-y-2">
                            <label class="text-[10px] font-bold text-gray-400 uppercase">Assignment</label>
                            <select onchange="bulkAssignList('${list.id}', this.value)" class="w-full p-3 bg-gray-50 rounded-xl text-sm border-none outline-none font-semibold">
                                <option value="">Select Telecaller...</option>
                                ${staff.map(s => `<option value="${s.id}" ${assignedTelecallerId === s.id ? 'selected' : ''}>${s.name}</option>`).join('')}
                            </select>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderStaff() {
            const container = document.getElementById('staff-container');
            if(!container) return;
            container.innerHTML = staff.map(s => {
                const staffLeads = leads.filter(l => l.assignedTo === s.id);
                return `<div class="bg-white p-6 rounded-3xl border shadow-sm">
                    <div class="flex justify-between items-start mb-4">
                        <div class="w-12 h-12 bg-blue-100 rounded-2xl flex items-center justify-center text-blue-600 font-bold text-xl">${s.name.charAt(0)}</div>
                        <button onclick="deleteStaff('${s.id}')" class="text-red-300 hover:text-red-500"><i class="fas fa-trash"></i></button>
                    </div>
                    <h4 class="font-bold text-lg">${s.name}</h4>
                    <p class="text-xs text-gray-400 font-mono mt-1 uppercase">ID: ${s.id}</p>
                    <div class="mt-4 flex justify-between border-t pt-4"><span class="text-[10px] font-bold text-gray-400 uppercase">Total Leads</span><span class="text-sm font-bold text-blue-600">${staffLeads.length}</span></div>
                </div>`;
            }).join('');
        }

        // --- CRUD ACTIONS ---
        window.openLeadModal = (id = null) => {
            editingLeadId = id;
            const titleEl = document.getElementById('lead-modal-title');
            const nameEl = document.getElementById('lead-name');
            const phoneEl = document.getElementById('lead-phone');
            const notesEl = document.getElementById('lead-notes');
            const followupEl = document.getElementById('lead-followup');

            if (id) {
                const l = leads.find(x => x.id === id);
                if (l) {
                    titleEl.innerText = "Update Lead";
                    nameEl.value = l.name || '';
                    phoneEl.value = l.phone || '';
                    notesEl.value = l.notes || '';
                    followupEl.value = l.followup || '';
                } else editingLeadId = null;
            } else {
                titleEl.innerText = "New Lead";
                nameEl.value = ''; phoneEl.value = ''; notesEl.value = ''; followupEl.value = '';
            }
            document.getElementById('lead-modal').classList.remove('hidden');
        };

        window.saveLead = async () => {
            const data = {
                name: document.getElementById('lead-name').value.trim(),
                phone: document.getElementById('lead-phone').value.trim(),
                notes: document.getElementById('lead-notes').value.trim(),
                followup: document.getElementById('lead-followup').value,
                updatedAt: Timestamp.now()
            };
            if (!data.name || !data.phone) return notify("Name & Phone required");

            setProcessing(true, "Saving changes...");
            try {
                if (editingLeadId) await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'leads', editingLeadId), data);
                else {
                    data.status = 'new'; data.assignedTo = window.currentUser.id; data.createdAt = Timestamp.now();
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'leads'), data);
                }
                document.getElementById('lead-modal').classList.add('hidden');
                notify("Lead saved");
            } catch (e) { notify("Error saving"); }
            setProcessing(false);
        };

        window.inlineEdit = async (id, field) => {
            const currentLead = leads.find(l => l.id === id);
            if (!currentLead) return;
            const currentVal = currentLead[field] || '';
            const val = prompt(`Edit ${field}:`, currentVal);
            if (val !== null && val !== currentVal) {
                setProcessing(true, "Updating...");
                try { await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'leads', id), { [field]: val, updatedAt: Timestamp.now() }); notify("Updated"); } catch (e) { notify("Update failed"); }
                setProcessing(false);
            }
        };

        // --- HELPERS ---
        function setProcessing(v, text = "Syncing Database...") { 
            isProcessing = v; document.getElementById('processing-text').innerText = text;
            document.getElementById('processing-overlay').classList.toggle('hidden', !v); 
            if (!v) { debouncedRenderLeads(); }
        }
        function notify(m) { const t = document.getElementById('toast'); document.getElementById('toast-msg').innerText = m; t.classList.remove('translate-y-20', 'opacity-0'); setTimeout(() => t.classList.add('translate-y-20', 'opacity-0'), 3000); }
        function getStatusStyle(s) { switch(s) { case 'new': return 'bg-blue-100 text-blue-700'; case 'follow-up': return 'bg-orange-100 text-orange-700'; case 'converted': return 'bg-green-100 text-green-700'; case 'rejected': return 'bg-red-100 text-red-700'; default: return 'bg-gray-100'; } }
        function updateStats() { const f = window.currentUser.role === 'admin' ? leads : leads.filter(l => l.assignedTo === window.currentUser.id); document.getElementById('stat-total').innerText = f.length; document.getElementById('stat-converted').innerText = f.filter(x => x.status === 'converted').length; document.getElementById('stat-pending').innerText = f.filter(x => x.status === 'new' || x.status === 'follow-up').length; document.getElementById('stat-rejected').innerText = f.filter(x => x.status === 'rejected').length; }
        function updateChart() { const canvas = document.getElementById('analyticsChart'); if (!canvas) return; const f = window.currentUser.role === 'admin' ? leads : leads.filter(l => l.assignedTo === window.currentUser.id); const counts = ['new', 'follow-up', 'converted', 'rejected'].map(s => f.filter(x => x.status === s).length); if (myChart) myChart.destroy(); myChart = new Chart(canvas.getContext('2d'), { type: 'bar', data: { labels: ['New', 'Follow', 'Conv', 'Rej'], datasets: [{ data: counts, backgroundColor: ['#3b82f6', '#f97316', '#10b981', '#ef4444'], borderRadius: 12 }] }, options: { responsive: true, maintainAspectRatio: false, animation: { duration: 400 }, plugins: { legend: { display: false } }, scales: { y: { display: false }, x: { grid: { display: false } } } } }); }
        
        window.updateStatus = async (id, status) => { setProcessing(true, "Updating Status..."); try { await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'leads', id), { status, updatedAt: Timestamp.now() }); notify("Status Updated"); } catch(e){} finally { setProcessing(false); } };
        window.openWA = (id) => { const l = leads.find(x => x.id === id); if (!l) return; let p = l.phone.replace(/\D/g, ''); if (p.length === 10) p = '91' + p; window.open(`https://wa.me/${p}?text=${encodeURIComponent('Hello ' + (l.name || 'there') + ', calling from FutureU Institute. Let\'s discuss further.')}`, '_blank'); };
        window.shareLead = (id) => { const l = leads.find(x => x.id === id); const text = `Lead: ${l.name}\nPhone: ${l.phone}\nStatus: ${l.status}`; if (navigator.share) navigator.share({ text }); else { const el = document.createElement('textarea'); el.value = text; document.body.appendChild(el); el.select(); document.execCommand('copy'); document.body.removeChild(el); notify("Copied!"); } };
        window.deleteLead = async (id) => { if (confirm("Delete Lead?")) { setProcessing(true, "Deleting..."); try { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'leads', id)); notify("Lead deleted"); } catch(e){} finally { setProcessing(false); } } };
        window.deleteStaff = async (id) => { if (confirm("Delete account?")) { setProcessing(true, "Removing Account..."); try { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', id)); notify("Account deleted"); } catch(e){} finally { setProcessing(false); } } };
        window.renameList = async (id) => { const list = leadLists.find(l => l.id === id); if (!list) return; const newName = prompt("Rename list:", list.name); if(newName && newName !== list.name) { await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'lead_groups', id), { name: newName }); notify("Renamed"); } };
        window.deleteList = async (id) => { if(confirm("Delete list and leads?")){ setProcessing(true, "Deleting..."); try { await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'lead_groups', id)); const toDel = leads.filter(l => l.listId === id); for(let l of toDel) await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'leads', l.id)); notify("Deleted"); } catch(e){} setProcessing(false); } };
        window.bulkAssignList = async (listId, staffId) => { if(!staffId) return; const staffName = staff.find(s => s.id === staffId)?.name; if(confirm(`Assign list to ${staffName}?`)) { setProcessing(true, "Assigning..."); try { const toAssign = leads.filter(l => l.listId === listId); for(let l of toAssign) await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'leads', l.id), { assignedTo: staffId, updatedAt: Timestamp.now() }); notify("Assigned"); } catch(e){} setProcessing(false); } };
        window.copyToClipboard = (text) => { const el = document.createElement('textarea'); el.value = text; document.body.appendChild(el); el.select(); document.execCommand('copy'); document.body.removeChild(el); notify("AI Script Copied!"); };
        window.toggleMobileMenu = (f) => { const s = document.getElementById('sidebar'); const target = f !== undefined ? f : !s.classList.contains('translate-x-0'); s.classList.toggle('translate-x-0', target); s.classList.toggle('-translate-x-full', !target); };
        window.closeLeadModal = () => document.getElementById('lead-modal').classList.add('hidden');
        window.closeStaffModal = () => document.getElementById('staff-modal').classList.add('hidden');
        window.openStaffModal = () => { document.getElementById('staff-name').value = ''; document.getElementById('staff-id').value = ''; document.getElementById('staff-pass').value = ''; document.getElementById('staff-modal').classList.remove('hidden'); };
        window.saveEmployee = async () => { const name = document.getElementById('staff-name').value.trim(); const id = document.getElementById('staff-id').value.trim(); const pass = document.getElementById('staff-pass').value.trim(); if (!name || !id || !pass) return notify("Fields required"); setProcessing(true, "Creating account..."); try { await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', id), { name, password: pass, role: 'telecaller', createdAt: Timestamp.now() }); closeStaffModal(); notify("Account created"); } catch (err) { notify("Error saving"); } setProcessing(false); };
        window.handleExcelUpload = (e) => {
            const file = e.target.files[0]; if (!file) return;
            const listName = prompt("Name for this List:", file.name.split('.')[0]); if (!listName) return;
            setProcessing(true, "Processing file...");
            const reader = new FileReader();
            reader.onload = async (ev) => {
                try {
                    const workbook = XLSX.read(new Uint8Array(ev.target.result), {type: 'array'});
                    const json = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { header: 0, defval: "" });
                    if (!json.length) return setProcessing(false);
                    const listDocRef = await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'lead_groups'), { name: listName, createdAt: Timestamp.now() });
                    let count = 0;
                    for (let row of json) {
                        const normalized = {}; Object.keys(row).forEach(k => normalized[k.trim().toLowerCase()] = row[k]);
                        const name = normalized.name || normalized['full name'] || "";
                        const phone = String(normalized.phone || normalized.mobile || normalized.contact || "").trim();
                        if (phone) { await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'leads'), { name, phone, status: 'new', assignedTo: window.currentUser.id, listId: listDocRef.id, updatedAt: Timestamp.now(), createdAt: Timestamp.now() }); count++; }
                    }
                    notify(`Imported ${count} leads.`); e.target.value = ""; showView('lists');
                } catch (err) { notify("Import failed."); }
                setProcessing(false);
            };
            reader.readAsArrayBuffer(file);
        };

        initAuth();
    </script>
</body>

</html>
