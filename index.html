<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FutureU Tele CRM - Pro App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .sidebar-active { background: rgba(59, 130, 246, 0.1); border-left: 4px solid #3b82f6; color: #3b82f6; }
        .bottom-nav-active { color: #3b82f6; font-weight: bold; }
        .hidden { display: none; }
        .modal-bg { background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(8px); }
        
        @media (max-width: 768px) {
            .hide-mobile { display: none; }
            .safe-area-pb { padding-bottom: 90px; }
        }

        .fade-in { animation: fadeIn 0.2s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        .loader {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        #processing-overlay { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); }
        .scroll-container { -webkit-overflow-scrolling: touch; }
        
        /* Mobile App Feel */
        .app-card { border-radius: 20px; transition: transform 0.1s active; }
        .app-card:active { transform: scale(0.98); }
        
        /* Checkbox styling */
        input[type="checkbox"]:checked { background-color: #3b82f6; border-color: #3b82f6; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen text-gray-800">

    <!-- Global Processing Overlay -->
    <div id="processing-overlay" class="fixed inset-0 z-[200] hidden flex flex-col items-center justify-center">
        <div class="loader w-14 h-14 border-4 mb-4"></div>
        <p id="processing-text" class="font-bold text-blue-600 animate-pulse text-lg">Optimizing Data...</p>
    </div>

    <!-- Auth Overlay -->
    <div id="auth-overlay" class="fixed inset-0 z-[100] flex items-center justify-center bg-blue-600 px-4">
        <div class="bg-white p-8 rounded-[2.5rem] shadow-2xl w-full max-w-md">
            <div class="text-center mb-8">
                <div class="w-20 h-20 bg-blue-100 text-blue-600 rounded-3xl flex items-center justify-center text-4xl mx-auto mb-4">
                    <i class="fas fa-rocket"></i>
                </div>
                <h1 class="text-2xl font-bold text-gray-900">FutureU CRM</h1>
                <p class="text-gray-500 text-sm mt-1">Enterprise Sales Engine</p>
            </div>
            <div class="space-y-4">
                <div id="login-error" class="hidden p-3 bg-red-50 text-red-600 text-xs rounded-xl text-center font-bold"></div>
                <input type="text" id="login-id" class="w-full p-5 bg-gray-50 border rounded-2xl outline-none focus:ring-2 ring-blue-500" placeholder="Employee ID">
                <input type="password" id="login-pass" class="w-full p-5 bg-gray-50 border rounded-2xl outline-none focus:ring-2 ring-blue-500" placeholder="Password">
                <button onclick="handleLogin()" id="login-btn" class="w-full bg-blue-600 text-white py-5 rounded-2xl font-bold hover:bg-blue-700 transition shadow-lg flex justify-center items-center gap-2">
                    Start Session
                </button>
                <p class="text-[10px] text-center text-gray-400 mt-4 uppercase font-bold tracking-widest">Admin: admin_01 / admin@123</p>
            </div>
        </div>
    </div>

    <!-- App Container -->
    <div id="app-container" class="hidden flex h-screen overflow-hidden">
        
        <!-- Sidebar (Desktop Only) -->
        <aside id="sidebar" class="fixed inset-y-0 left-0 z-50 w-64 bg-white border-r flex flex-col transform -translate-x-full transition-transform md:relative md:translate-x-0">
            <div class="p-6 border-b">
                <h2 class="text-xl font-bold text-blue-600 flex items-center gap-2">
                    <i class="fas fa-rocket"></i> FutureU CRM
                </h2>
            </div>
            <nav class="flex-1 p-4 space-y-2 overflow-y-auto scroll-container">
                <button onclick="showView('dashboard')" class="sidebar-btn w-full flex items-center gap-3 p-4 rounded-2xl transition" id="btn-dashboard">
                    <i class="fas fa-chart-line"></i> Dashboard
                </button>
                <button onclick="showView('leads')" class="sidebar-btn w-full flex items-center gap-3 p-4 rounded-2xl transition" id="btn-leads">
                    <i class="fas fa-users"></i> Lead Bucket
                </button>
                <button onclick="showView('lists')" class="sidebar-btn w-full flex items-center gap-3 p-4 rounded-2xl transition admin-only" id="btn-lists">
                    <i class="fas fa-layer-group"></i> Lead Lists
                </button>
                <button onclick="showView('staff')" class="sidebar-btn w-full flex items-center gap-3 p-4 rounded-2xl transition admin-only" id="btn-staff">
                    <i class="fas fa-user-friends"></i> Staff Portal
                </button>
            </nav>
            <div class="p-4 border-t">
                <div class="flex items-center gap-3 mb-4 p-3 bg-gray-50 rounded-2xl">
                    <div class="w-10 h-10 rounded-full bg-blue-600 flex items-center justify-center text-white font-bold" id="user-avatar">?</div>
                    <div class="truncate">
                        <p class="text-sm font-bold truncate" id="user-name">User</p>
                        <p class="text-[10px] text-gray-400 font-bold uppercase tracking-wider" id="user-role-label">Role</p>
                    </div>
                </div>
                <button onclick="logout()" class="w-full flex items-center gap-3 p-3 text-red-500 rounded-xl hover:bg-red-50 transition font-medium">
                    <i class="fas fa-power-off"></i> Logout
                </button>
            </div>
        </aside>

        <!-- Main Content Area -->
        <main class="flex-1 overflow-y-auto bg-gray-50 pb-24 md:pb-8 scroll-container relative safe-area-pb">
            <div class="p-4 md:p-8 max-w-6xl mx-auto space-y-6">
                
                <!-- Dashboard View -->
                <section id="view-dashboard" class="view space-y-6 fade-in">
                    <div class="flex flex-col md:flex-row justify-between md:items-center">
                        <h1 class="text-2xl font-bold">Institute Analytics</h1>
                        <p class="text-xs font-bold text-blue-500 uppercase tracking-widest bg-blue-50 px-3 py-1 rounded-full">Real-time Cloud Sync</p>
                    </div>

                    <div class="grid grid-cols-2 lg:grid-cols-4 gap-3 md:gap-4">
                        <div class="bg-white p-6 rounded-[1.5rem] border shadow-sm">
                            <p class="text-gray-400 text-[10px] font-bold uppercase">Active Leads</p>
                            <h3 class="text-2xl font-bold mt-1" id="stat-total">0</h3>
                        </div>
                        <div class="bg-green-600 p-6 rounded-[1.5rem] text-white shadow-lg shadow-green-100">
                            <p class="text-green-100 text-[10px] font-bold uppercase">Converted</p>
                            <h3 class="text-2xl font-bold mt-1" id="stat-converted">0</h3>
                        </div>
                        <div class="bg-white p-6 rounded-[1.5rem] border shadow-sm text-orange-500">
                            <p class="text-gray-400 text-[10px] font-bold uppercase">Due Today</p>
                            <h3 class="text-2xl font-bold mt-1" id="stat-pending">0</h3>
                        </div>
                        <div class="bg-white p-6 rounded-[1.5rem] border shadow-sm text-red-500">
                            <p class="text-gray-400 text-[10px] font-bold uppercase">Rejected</p>
                            <h3 class="text-2xl font-bold mt-1" id="stat-rejected">0</h3>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div class="lg:col-span-2 bg-white p-6 rounded-[2rem] border shadow-sm">
                            <h4 class="font-bold mb-4 flex items-center gap-2"><i class="fas fa-chart-bar text-blue-500"></i> Conversion Funnel</h4>
                            <div class="h-64 relative"><canvas id="analyticsChart"></canvas></div>
                        </div>
                        <div class="bg-gray-900 p-6 rounded-[2rem] text-white flex flex-col">
                            <h4 class="font-bold mb-4 flex items-center gap-2"><i class="fas fa-crown text-yellow-400"></i> Top Closers</h4>
                            <div id="leaderboard" class="space-y-4 overflow-y-auto flex-1 text-sm">
                                <!-- Leaderboard injected -->
                                <p class="text-gray-500 text-center py-10">Waiting for data...</p>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Lead Bucket View -->
                <section id="view-leads" class="view hidden space-y-4 fade-in">
                    <div class="flex justify-between items-center">
                        <h1 class="text-2xl font-bold">Bucket</h1>
                        <div class="flex gap-2">
                             <button onclick="toggleSelectMode()" id="select-mode-btn" class="bg-gray-100 text-gray-600 px-4 py-3 rounded-2xl font-bold active:scale-95 transition">
                                <i class="fas fa-check-square"></i>
                            </button>
                             <button onclick="exportCurrentLeads()" class="bg-white border border-gray-200 text-gray-700 px-4 py-3 rounded-2xl font-bold active:scale-95 transition">
                                <i class="fas fa-download"></i>
                            </button>
                            <button onclick="openLeadModal()" class="bg-blue-600 text-white px-6 py-3 rounded-2xl font-bold shadow-lg active:scale-95 transition">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Filter Bar -->
                    <div class="bg-white p-3 rounded-2xl border flex flex-col gap-2">
                        <div class="relative">
                            <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
                            <input type="text" id="search-input" oninput="debouncedRenderLeads()" class="w-full pl-12 pr-4 py-4 bg-gray-50 rounded-xl outline-none" placeholder="Search phone or name...">
                        </div>
                        <div class="grid grid-cols-2 gap-2">
                            <select id="filter-status" onchange="debouncedRenderLeads()" class="p-4 bg-gray-50 rounded-xl font-bold text-sm outline-none border-none">
                                <option value="all">All Status</option>
                                <option value="new">üÜï New</option>
                                <option value="follow-up">‚è≥ Follow-up</option>
                                <option value="converted">‚úÖ Converted</option>
                                <option value="rejected">‚ùå Rejected</option>
                            </select>
                            <select id="sort-order" onchange="debouncedRenderLeads()" class="p-4 bg-gray-50 rounded-xl font-bold text-sm outline-none border-none">
                                <option value="newest">Latest</option>
                                <option value="name">A-Z</option>
                                <option value="followup">Due First</option>
                            </select>
                        </div>
                    </div>

                    <!-- Batch Actions (Conditional) -->
                    <div id="batch-actions" class="hidden bg-blue-600 p-4 rounded-2xl flex justify-between items-center text-white shadow-xl">
                        <span id="selected-count" class="font-bold">0 Selected</span>
                        <div class="flex gap-2">
                            <button onclick="batchStatusUpdate()" class="bg-white text-blue-600 px-4 py-2 rounded-xl text-xs font-bold uppercase">Update Status</button>
                            <button onclick="batchDelete()" class="bg-red-500 text-white px-4 py-2 rounded-xl text-xs font-bold uppercase">Delete</button>
                            <button onclick="toggleSelectMode(false)" class="text-white px-2"><i class="fas fa-times"></i></button>
                        </div>
                    </div>

                    <div id="leads-container" class="space-y-4"></div>
                    <div id="load-more-btn" class="hidden text-center py-6">
                        <button onclick="loadMoreLeads()" class="bg-gray-900 text-white px-10 py-4 rounded-2xl font-bold active:scale-95 transition">View More</button>
                    </div>
                </section>

                <!-- Lead Lists View -->
                <section id="view-lists" class="view hidden space-y-6 fade-in">
                    <div class="flex justify-between items-center">
                        <h1 class="text-2xl font-bold">Marketing Lists</h1>
                        <button onclick="document.getElementById('excel-input').click()" class="bg-blue-600 text-white px-6 py-3 rounded-2xl font-bold flex items-center gap-2 active:scale-95 transition">
                            <i class="fas fa-upload"></i> Upload
                        </button>
                        <input type="file" id="excel-input" class="hidden" accept=".xlsx,.xls,.csv" onchange="handleExcelUpload(event)">
                    </div>
                    
                    <div class="bg-blue-50 p-6 rounded-3xl border border-blue-100 flex items-center justify-between">
                        <div>
                            <h4 class="font-bold text-blue-900">Auto-Distribute Mode</h4>
                            <p class="text-xs text-blue-700">Fairly rotate leads between all active staff during import.</p>
                        </div>
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="auto-assign-toggle" class="sr-only peer">
                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                        </label>
                    </div>

                    <div id="lists-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
                </section>

                <!-- Staff View -->
                <section id="view-staff" class="view hidden space-y-6 fade-in">
                    <div class="flex justify-between items-center">
                        <h1 class="text-2xl font-bold">Team</h1>
                        <button onclick="openStaffModal()" class="bg-black text-white px-6 py-3 rounded-2xl font-bold active:scale-95 transition">
                            <i class="fas fa-user-plus"></i>
                        </button>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="staff-container"></div>
                </section>

            </div>
        </main>

        <!-- Bottom Mobile Nav -->
        <nav class="md:hidden fixed bottom-0 left-0 right-0 bg-white border-t flex justify-around p-4 z-50">
            <button onclick="showView('dashboard')" class="bottom-nav-btn flex flex-col items-center gap-1 text-gray-400" id="m-btn-dashboard">
                <i class="fas fa-th-large text-xl"></i>
                <span class="text-[10px] font-bold uppercase tracking-tighter">Stats</span>
            </button>
            <button onclick="showView('leads')" class="bottom-nav-btn flex flex-col items-center gap-1 text-gray-400" id="m-btn-leads">
                <i class="fas fa-headset text-xl"></i>
                <span class="text-[10px] font-bold uppercase tracking-tighter">Calls</span>
            </button>
            <button onclick="showView('lists')" class="bottom-nav-btn flex flex-col items-center gap-1 text-gray-400 admin-only" id="m-btn-lists">
                <i class="fas fa-file-invoice text-xl"></i>
                <span class="text-[10px] font-bold uppercase tracking-tighter">Lists</span>
            </button>
            <button onclick="showView('staff')" class="bottom-nav-btn flex flex-col items-center gap-1 text-gray-400 admin-only" id="m-btn-staff">
                <i class="fas fa-users text-xl"></i>
                <span class="text-[10px] font-bold uppercase tracking-tighter">Team</span>
            </button>
        </nav>
    </div>

    <!-- Modals -->
    <!-- WA Template Picker -->
    <div id="wa-modal" class="fixed inset-0 z-[130] hidden flex items-center justify-center p-4 modal-bg">
        <div class="bg-white rounded-[2.5rem] w-full max-w-sm shadow-2xl p-8 space-y-6">
            <h3 class="text-xl font-bold text-center">Send WhatsApp</h3>
            <div class="space-y-2" id="wa-templates">
                <!-- Templates generated -->
            </div>
            <button onclick="document.getElementById('wa-modal').classList.add('hidden')" class="w-full text-gray-400 font-bold py-2">Cancel</button>
        </div>
    </div>

    <!-- AI Modal -->
    <div id="ai-modal" class="fixed inset-0 z-[120] hidden flex items-center justify-center p-4 modal-bg">
        <div class="bg-white rounded-[2rem] w-full max-w-lg shadow-2xl overflow-hidden p-8 space-y-6 ai-glow">
            <div class="flex justify-between items-center">
                <h3 class="text-xl font-bold text-blue-600 flex items-center gap-2"><i class="fas fa-magic"></i> FutureU AI</h3>
                <button onclick="document.getElementById('ai-modal').classList.add('hidden')" class="text-gray-400"><i class="fas fa-times"></i></button>
            </div>
            <div id="ai-content" class="bg-blue-50 p-6 rounded-2xl text-blue-900 leading-relaxed italic border border-blue-100 min-h-[100px] flex items-center justify-center text-sm"></div>
            <button onclick="copyToClipboard(document.getElementById('ai-content').innerText)" class="w-full py-5 bg-blue-600 text-white rounded-2xl font-bold shadow-lg">Copy Script</button>
        </div>
    </div>

    <!-- Lead Modal with Timeline -->
    <div id="lead-modal" class="fixed inset-0 z-[110] hidden flex items-center justify-center p-4 modal-bg">
        <div class="bg-white rounded-[2.5rem] w-full max-w-lg shadow-2xl overflow-hidden flex flex-col h-[90vh]">
            <div class="p-6 border-b flex justify-between items-center bg-gray-50">
                <h3 class="font-bold text-lg" id="lead-modal-title">Lead Profile</h3>
                <button onclick="closeLeadModal()" class="w-10 h-10 flex items-center justify-center rounded-full bg-white shadow-sm"><i class="fas fa-times text-gray-400"></i></button>
            </div>
            <div class="flex-1 overflow-y-auto p-6 space-y-6 scroll-container">
                <div class="space-y-4">
                    <input type="text" id="lead-name" placeholder="Candidate Name" class="w-full p-4 bg-gray-50 rounded-2xl outline-none border">
                    <input type="tel" id="lead-phone" placeholder="Phone Number" class="w-full p-4 bg-gray-50 rounded-2xl outline-none border">
                    <input type="text" id="lead-course" placeholder="Interested Course (BBA, MBA, IT...)" class="w-full p-4 bg-gray-50 rounded-2xl outline-none border">
                    <div>
                        <label class="text-[10px] font-bold text-gray-400 uppercase ml-2 mb-1 block">Scheduled Follow-up</label>
                        <input type="date" id="lead-followup" class="w-full p-4 bg-gray-50 rounded-2xl outline-none border">
                    </div>
                    <textarea id="lead-notes" rows="2" placeholder="Recent Conversation Notes..." class="w-full p-4 bg-gray-50 rounded-2xl outline-none border"></textarea>
                </div>
                
                <div id="lead-history-section" class="hidden space-y-4 border-t pt-6">
                    <h4 class="text-xs font-bold text-gray-400 uppercase tracking-widest">Lead Timeline</h4>
                    <div id="lead-history-list" class="space-y-3"></div>
                </div>
            </div>
            <div class="p-6 bg-gray-50 flex gap-3">
                <button onclick="saveLead()" class="flex-1 py-5 bg-blue-600 text-white rounded-2xl font-bold shadow-lg">Save Profile</button>
            </div>
        </div>
    </div>

    <!-- Staff Modal -->
    <div id="staff-modal" class="fixed inset-0 z-[110] hidden flex items-center justify-center p-4 modal-bg">
        <div class="bg-white rounded-[2rem] w-full max-w-md shadow-2xl p-8 space-y-6">
            <h3 class="text-xl font-bold text-center">New Employee</h3>
            <div class="space-y-4">
                <input type="text" id="staff-name" placeholder="Employee Name" class="w-full p-4 bg-gray-50 rounded-2xl border outline-none">
                <input type="text" id="staff-id" placeholder="Login ID (EMP01)" class="w-full p-4 bg-gray-50 rounded-2xl border outline-none">
                <input type="text" id="staff-pass" placeholder="Password" class="w-full p-4 bg-gray-50 rounded-2xl border outline-none">
            </div>
            <div class="flex gap-3">
                <button onclick="closeStaffModal()" class="flex-1 py-4 text-gray-400 font-bold">Cancel</button>
                <button onclick="saveEmployee()" class="flex-1 py-4 bg-black text-white rounded-2xl font-bold">Create</button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="fixed bottom-24 md:bottom-8 left-1/2 -translate-x-1/2 md:left-auto md:right-8 md:translate-x-0 translate-y-20 opacity-0 transition-all duration-300 bg-gray-900 text-white px-6 py-4 rounded-2xl shadow-2xl z-[150]">
        <span id="toast-msg">Success</span>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, query, onSnapshot, updateDoc, deleteDoc, addDoc, Timestamp, arrayUnion } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyAraa3TDkLEs0tj0REa918PjlD_GAuHL0c",
            authDomain: "telecrm-c0cd8.firebaseapp.com",
            projectId: "telecrm-c0cd8",
            storageBucket: "telecrm-c0cd8.firebasestorage.app",
            messagingSenderId: "958261959120",
            appId: "1:958261959120:web:7938f2e4dedcbffc0bc1d5"
        };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'telecrm-c0cd8';
        const apiKey = ""; // Set by environment

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // State
        let user = null;
        let leads = [];
        let staff = [];
        let leadLists = [];
        let myChart = null;
        let editingLeadId = null;
        let isProcessing = false;
        let selectMode = false;
        let selectedLeads = new Set();
        let renderLimit = 50;

        // --- AUTH ---
        const initAuth = async () => {
            if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                await signInWithCustomToken(auth, __initial_auth_token);
            } else {
                await signInAnonymously(auth);
            }
        };

        onAuthStateChanged(auth, (u) => {
            user = u;
            const session = localStorage.getItem('crm_session_v2');
            if (session && u) {
                window.currentUser = JSON.parse(session);
                setupApp();
            }
        });

        window.handleLogin = async () => {
            const id = document.getElementById('login-id').value.trim();
            const pass = document.getElementById('login-pass').value.trim();
            if (!id || !pass) return;

            if (id === 'admin_01' && pass === 'admin@123') {
                proceedLogin({ id, name: 'Principal Admin', role: 'admin' });
                return;
            }

            try {
                const userRef = doc(db, 'artifacts', appId, 'public', 'data', 'users', id);
                const userSnap = await getDoc(userRef);
                if (userSnap.exists() && userSnap.data().password === pass) {
                    proceedLogin({ id, name: userSnap.data().name, role: 'telecaller' });
                } else {
                    notify("Invalid Login Details", "error");
                }
            } catch (err) { notify("Auth Error"); }
        };

        function proceedLogin(userData) {
            window.currentUser = userData;
            localStorage.setItem('crm_session_v2', JSON.stringify(userData));
            if (!user) initAuth(); else setupApp();
        }

        window.logout = () => { localStorage.removeItem('crm_session_v2'); location.reload(); };

        // --- CORE APP ---
        function setupApp() {
            if (!user) return;
            document.getElementById('auth-overlay').classList.add('hidden');
            document.getElementById('app-container').classList.remove('hidden');
            document.getElementById('user-name').innerText = window.currentUser.name;
            document.getElementById('user-role-label').innerText = window.currentUser.role;
            document.getElementById('user-avatar').innerText = window.currentUser.name.charAt(0);

            if (window.currentUser.role !== 'admin') document.querySelectorAll('.admin-only').forEach(e => e.remove());
            
            Notification.requestPermission();

            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'leads'), (snap) => {
                leads = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                if (!isProcessing) { renderLeads(); updateStats(); updateChart(); updateLeaderboard(); }
            });

            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'users'), (snap) => {
                staff = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                if (window.currentUser.role === 'admin') renderStaff();
            });

            onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'lead_groups'), (snap) => {
                leadLists = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                updateListFilters();
                if(window.currentUser.role === 'admin') renderLists();
            });

            showView('dashboard');
        }

        window.showView = (name) => {
            document.querySelectorAll('.view').forEach(v => v.classList.add('hidden'));
            document.getElementById('view-' + name).classList.remove('hidden');
            document.querySelectorAll('.sidebar-btn').forEach(b => b.classList.remove('sidebar-active'));
            document.getElementById('btn-' + name).classList.add('sidebar-active');
            
            // Bottom Nav Sync
            document.querySelectorAll('.bottom-nav-btn').forEach(b => b.classList.remove('bottom-nav-active'));
            const mobileBtn = document.getElementById('m-btn-' + name);
            if(mobileBtn) mobileBtn.classList.add('bottom-nav-active');

            if (name === 'dashboard') updateChart();
            if (name === 'leads') renderLeads();
        };

        // --- DASHBOARD OPTIMIZATIONS ---
        function updateLeaderboard() {
            const container = document.getElementById('leaderboard');
            const stats = staff.map(s => {
                const count = leads.filter(l => l.assignedTo === s.id && l.status === 'converted').length;
                return { name: s.name, count };
            }).sort((a,b) => b.count - a.count);

            container.innerHTML = stats.map((s, idx) => `
                <div class="flex justify-between items-center bg-white/10 p-4 rounded-2xl">
                    <div class="flex items-center gap-3">
                        <span class="font-black text-gray-500">${idx+1}</span>
                        <span class="font-bold">${s.name}</span>
                    </div>
                    <span class="text-xs bg-green-500 text-white px-3 py-1 rounded-full font-black">${s.count} ADM</span>
                </div>
            `).join('');
        }

        // --- LEADS RENDERING ---
        window.renderLeads = () => {
            const container = document.getElementById('leads-container');
            if (!container) return;

            const statusFilter = document.getElementById('filter-status').value;
            const sortOrder = document.getElementById('sort-order').value;
            const searchQuery = (document.getElementById('search-input')?.value || "").toLowerCase();

            let filtered = [...leads];
            if (window.currentUser.role !== 'admin') filtered = filtered.filter(l => l.assignedTo === window.currentUser.id);
            if (statusFilter !== 'all') filtered = filtered.filter(l => l.status === statusFilter);
            if (searchQuery) filtered = filtered.filter(l => (l.name && l.name.toLowerCase().includes(searchQuery)) || (l.phone && l.phone.includes(searchQuery)));

            if (sortOrder === 'name') filtered.sort((a,b) => (a.name || "").localeCompare(b.name || ""));
            else if (sortOrder === 'followup') filtered.sort((a,b) => (new Date(a.followup || "9999-12-31")) - (new Date(b.followup || "9999-12-31")));
            else filtered.sort((a,b) => (b.updatedAt?.seconds || 0) - (a.updatedAt?.seconds || 0));

            const displaySubset = filtered.slice(0, renderLimit);
            const today = new Date().toISOString().split('T')[0];

            container.innerHTML = displaySubset.map(l => {
                const isDue = l.followup && l.followup <= today && l.status !== 'converted' && l.status !== 'rejected';
                return `
                <div class="bg-white p-5 app-card border shadow-sm space-y-4 fade-in ${isDue ? 'border-orange-200 bg-orange-50/20' : ''}">
                    <div class="flex justify-between items-start">
                        <div class="flex items-start gap-3">
                            ${selectMode ? `<input type="checkbox" onchange="toggleLeadSelection('${l.id}')" ${selectedLeads.has(l.id) ? 'checked' : ''} class="w-6 h-6 mt-1 rounded-full border-2 border-gray-200">` : ''}
                            <div class="flex-1">
                                <h3 class="text-lg font-bold flex items-center gap-2" onclick="window.inlineEdit('${l.id}', 'name')">
                                    ${l.name || '<span class="text-gray-300">Unlabeled</span>'}
                                    ${isDue ? '<span class="w-2 h-2 bg-orange-500 rounded-full animate-ping"></span>' : ''}
                                </h3>
                                <p class="text-sm font-mono text-gray-500 flex items-center gap-2">
                                    ${l.phone} 
                                    <a href="https://www.truecaller.com/search/in/${l.phone.replace(/\D/g,'')}" target="_blank" class="text-blue-400 text-xs"><i class="fas fa-check-circle"></i> Verify</a>
                                </p>
                                <div class="flex gap-1 mt-1">
                                    ${l.course ? `<span class="text-[9px] bg-blue-100 text-blue-600 px-2 py-0.5 rounded font-black uppercase">${l.course}</span>` : ''}
                                    ${l.followup ? `<span class="text-[9px] bg-gray-100 text-gray-600 px-2 py-0.5 rounded font-bold">üìÖ ${l.followup}</span>` : ''}
                                </div>
                            </div>
                        </div>
                        <div class="flex flex-col items-end gap-2">
                            <button onclick="window.getAIPitch('${l.id}')" class="text-blue-500 bg-blue-50 w-8 h-8 rounded-full flex items-center justify-center hover:bg-blue-100 transition"><i class="fas fa-magic text-xs"></i></button>
                            <select onchange="window.updateStatus('${l.id}', this.value)" class="text-[10px] font-bold px-3 py-1 rounded-xl border-none outline-none ${getStatusStyle(l.status)}">
                                <option value="new" ${l.status === 'new' ? 'selected' : ''}>NEW</option>
                                <option value="follow-up" ${l.status === 'follow-up' ? 'selected' : ''}>FOLLOW-UP</option>
                                <option value="converted" ${l.status === 'converted' ? 'selected' : ''}>CONVERTED</option>
                                <option value="rejected" ${l.status === 'rejected' ? 'selected' : ''}>REJECTED</option>
                            </select>
                        </div>
                    </div>
                    <div class="grid grid-cols-4 gap-2">
                        <a href="tel:${l.phone}" class="col-span-2 bg-blue-600 text-white h-14 rounded-2xl flex items-center justify-center gap-2 font-bold shadow-lg active:scale-95 transition">
                            <i class="fas fa-phone-alt"></i> CALL
                        </a>
                        <button onclick="pickWATemplate('${l.id}')" class="bg-green-100 text-green-600 rounded-2xl flex items-center justify-center active:scale-95 transition"><i class="fab fa-whatsapp text-2xl"></i></button>
                        <button onclick="window.shareLead('${l.id}')" class="bg-gray-100 text-gray-500 rounded-2xl flex items-center justify-center active:scale-95 transition"><i class="fas fa-share-alt"></i></button>
                    </div>
                    <div class="flex justify-between border-t pt-3">
                         <span class="text-[9px] text-gray-400 font-bold">LAST ACT: ${l.updatedAt?.toDate().toLocaleDateString() || '--'}</span>
                         <div class="flex gap-4">
                            <button onclick="window.openLeadModal('${l.id}')" class="text-blue-500 font-bold text-xs uppercase tracking-widest">Profile</button>
                            ${window.currentUser.role === 'admin' ? `<button onclick="window.deleteLead('${l.id}')" class="text-red-300 font-bold text-xs uppercase">Del</button>` : ''}
                         </div>
                    </div>
                </div>
            `;}).join('');

            document.getElementById('load-more-btn').classList.toggle('hidden', filtered.length <= renderLimit);
        };

        // --- BATCH ACTIONS ---
        window.toggleSelectMode = (force) => {
            selectMode = force !== undefined ? force : !selectMode;
            selectedLeads.clear();
            document.getElementById('batch-actions').classList.toggle('hidden', !selectMode);
            renderLeads();
        };

        window.toggleLeadSelection = (id) => {
            if(selectedLeads.has(id)) selectedLeads.delete(id);
            else selectedLeads.add(id);
            document.getElementById('selected-count').innerText = `${selectedLeads.size} Selected`;
        };

        window.batchDelete = async () => {
            if(confirm(`Delete ${selectedLeads.size} leads permanently?`)){
                setProcessing(true, "Batch Deleting...");
                for(let id of selectedLeads) await deleteDoc(doc(db, 'artifacts', appId, 'public', 'data', 'leads', id));
                toggleSelectMode(false);
                setProcessing(false);
            }
        };

        window.batchStatusUpdate = async () => {
            const newStatus = prompt("Update selected to (new, follow-up, converted, rejected):", "follow-up");
            if(newStatus && ['new','follow-up','converted','rejected'].includes(newStatus)){
                setProcessing(true, "Updating Batch...");
                for(let id of selectedLeads) await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'leads', id), { status: newStatus, updatedAt: Timestamp.now() });
                toggleSelectMode(false);
                setProcessing(false);
            }
        };

        // --- WHATSAPP TEMPLATES ---
        window.pickWATemplate = (id) => {
            const l = leads.find(x => x.id === id);
            const templates = [
                { name: "Inquiry Intro", text: `Hi ${l.name || 'there'}, this is from FutureU Institute regarding your inquiry. Please let us know a good time to call.` },
                { name: "Follow-up", text: `Hello ${l.name || 'there'}, we didn't hear back from you. Are you still interested in our professional courses?` },
                { name: "Admission Info", text: `Greetings! Admissions are closing for the current batch. Visit our office or call us for the brochure.` }
            ];
            
            document.getElementById('wa-templates').innerHTML = templates.map((t, idx) => `
                <button onclick="window.openWA('${id}', '${t.text.replace(/'/g, "\\'")}')" class="w-full text-left p-4 bg-gray-50 rounded-2xl border hover:bg-green-50 hover:border-green-100 transition">
                    <p class="text-[10px] font-bold text-green-600 uppercase mb-1">${t.name}</p>
                    <p class="text-xs text-gray-700 italic">${t.text.substring(0, 60)}...</p>
                </button>
            `).join('');
            document.getElementById('wa-modal').classList.remove('hidden');
        };

        window.openWA = (id, msg) => {
            const l = leads.find(x => x.id === id);
            if (!l) return;
            let p = l.phone.replace(/\D/g, '');
            if (p.length === 10) p = '91' + p; 
            window.open(`https://wa.me/${p}?text=${encodeURIComponent(msg)}`, '_blank');
            document.getElementById('wa-modal').classList.add('hidden');
        };

        // --- CRUD & LOGGING ---
        window.saveLead = async () => {
            const data = {
                name: document.getElementById('lead-name').value.trim(),
                phone: document.getElementById('lead-phone').value.trim(),
                course: document.getElementById('lead-course').value.trim(),
                notes: document.getElementById('lead-notes').value.trim(),
                followup: document.getElementById('lead-followup').value,
                updatedAt: Timestamp.now()
            };
            if (!data.name || !data.phone) return notify("Missing Info");

            setProcessing(true, "Syncing Profile...");
            try {
                const historyEntry = {
                    date: new Date().toLocaleString(),
                    user: window.currentUser.name,
                    note: data.notes || "Updated profile"
                };

                if (editingLeadId) {
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'leads', editingLeadId), {
                        ...data,
                        history: arrayUnion(historyEntry)
                    });
                } else {
                    data.status = 'new'; 
                    data.assignedTo = window.currentUser.id; 
                    data.createdAt = Timestamp.now();
                    data.history = [historyEntry];
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'leads'), data);
                }
                closeLeadModal();
                notify("Cloud Updated");
            } catch (e) { notify("Save Error"); }
            setProcessing(false);
        };

        window.openLeadModal = (id = null) => {
            editingLeadId = id;
            const historyList = document.getElementById('lead-history-list');
            const historySection = document.getElementById('lead-history-section');

            if (id) {
                const l = leads.find(x => x.id === id);
                document.getElementById('lead-name').value = l.name || '';
                document.getElementById('lead-phone').value = l.phone || '';
                document.getElementById('lead-course').value = l.course || '';
                document.getElementById('lead-notes').value = l.notes || '';
                document.getElementById('lead-followup').value = l.followup || '';
                
                historySection.classList.remove('hidden');
                historyList.innerHTML = (l.history || []).map(h => `
                    <div class="bg-gray-50 p-3 rounded-xl border">
                        <div class="flex justify-between text-[8px] font-black uppercase text-gray-400 mb-1">
                            <span>${h.user}</span>
                            <span>${h.date}</span>
                        </div>
                        <p class="text-xs text-gray-700">${h.note}</p>
                    </div>
                `).join('') || '<p class="text-xs text-gray-300 italic">No history yet.</p>';
            } else {
                document.querySelectorAll('#lead-modal input, #lead-modal textarea').forEach(i => i.value = '');
                historySection.classList.add('hidden');
            }
            document.getElementById('lead-modal').classList.remove('hidden');
        };

        // --- EXCEL IMPORT (DUPLICATE DETECTION & ROUND ROBIN) ---
        window.handleExcelUpload = (e) => {
            const file = e.target.files[0]; if (!file) return;
            const listName = prompt("Import Name:", file.name.split('.')[0]); if (!listName) return;
            const autoAssign = document.getElementById('auto-assign-toggle').checked;
            
            setProcessing(true, "Scanning for Duplicates...");
            const reader = new FileReader();
            reader.onload = async (ev) => {
                try {
                    const workbook = XLSX.read(new Uint8Array(ev.target.result), {type: 'array'});
                    const json = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], { header: 0, defval: "" });
                    
                    const listRef = await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'lead_groups'), { name: listName, createdAt: Timestamp.now() });
                    
                    let imported = 0, skipped = 0, staffIdx = 0;
                    for (let row of json) {
                        const normalized = {}; Object.keys(row).forEach(k => normalized[k.trim().toLowerCase()] = row[k]);
                        const phone = String(normalized.phone || normalized.mobile || normalized.contact || "").trim();
                        const name = normalized.name || normalized['full name'] || "";

                        // Duplicate Check
                        if (leads.some(l => l.phone === phone)) { skipped++; continue; }

                        if (phone) {
                            const assignee = autoAssign ? staff[staffIdx % staff.length].id : window.currentUser.id;
                            await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'leads'), { 
                                name, phone, status: 'new', assignedTo: assignee, listId: listRef.id, 
                                updatedAt: Timestamp.now(), createdAt: Timestamp.now() 
                            });
                            imported++;
                            if(autoAssign) staffIdx++;
                        }
                    }
                    notify(`Imported: ${imported} | Skipped: ${skipped}`);
                    showView('lists');
                } catch (err) { notify("Import Failed"); }
                setProcessing(false);
            };
            reader.readAsArrayBuffer(file);
        };

        // --- HELPERS ---
        function setProcessing(v, text) { isProcessing = v; document.getElementById('processing-text').innerText = text || "Syncing..."; document.getElementById('processing-overlay').classList.toggle('hidden', !v); if(!v) renderLeads(); }
        function notify(m) { const t = document.getElementById('toast'); document.getElementById('toast-msg').innerText = m; t.classList.remove('translate-y-20', 'opacity-0'); setTimeout(() => t.classList.add('translate-y-20', 'opacity-0'), 3000); }
        function getStatusStyle(s) { switch(s) { case 'new': return 'bg-blue-100 text-blue-700'; case 'follow-up': return 'bg-orange-100 text-orange-700'; case 'converted': return 'bg-green-100 text-green-700'; case 'rejected': return 'bg-red-100 text-red-700'; default: return 'bg-gray-100'; } }
        function updateStats() { const f = window.currentUser.role === 'admin' ? leads : leads.filter(l => l.assignedTo === window.currentUser.id); document.getElementById('stat-total').innerText = f.length; document.getElementById('stat-converted').innerText = f.filter(x => x.status === 'converted').length; document.getElementById('stat-pending').innerText = f.filter(x => x.status === 'new' || x.status === 'follow-up').length; document.getElementById('stat-rejected').innerText = f.filter(x => x.status === 'rejected').length; }
        function updateChart() { const canvas = document.getElementById('analyticsChart'); if (!canvas) return; const counts = ['new', 'follow-up', 'converted', 'rejected'].map(s => leads.filter(x => x.status === s).length); if (myChart) myChart.destroy(); myChart = new Chart(canvas.getContext('2d'), { type: 'bar', data: { labels: ['New', 'Follow', 'Conv', 'Rej'], datasets: [{ data: counts, backgroundColor: ['#3b82f6', '#f97316', '#10b981', '#ef4444'], borderRadius: 12 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { display: false }, x: { grid: { display: false } } } } }); }
        
        // Window Exports for dynamic HTML
        window.debouncedRenderLeads = () => { if(renderTimeout) clearTimeout(renderTimeout); renderTimeout = setTimeout(renderLeads, 200); };
        window.loadMoreLeads = () => { renderLimit += 50; renderLeads(); };
        window.copyToClipboard = (t) => { const el = document.createElement('textarea'); el.value = t; document.body.appendChild(el); el.select(); document.execCommand('copy'); document.body.removeChild(el); notify("Copied!"); };
        window.closeLeadModal = () => document.getElementById('lead-modal').classList.add('hidden');
        window.closeStaffModal = () => document.getElementById('staff-modal').classList.add('hidden');
        window.openStaffModal = () => document.getElementById('staff-modal').classList.remove('hidden');
        window.updateStatus = async (id, status) => { await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'leads', id), { status, updatedAt: Timestamp.now() }); notify("Updated"); };
        window.getAIPitch = async (id) => {
            const l = leads.find(x => x.id === id);
            const modal = document.getElementById('ai-modal');
            const content = document.getElementById('ai-content');
            modal.classList.remove('hidden');
            content.innerHTML = '<div class="loader"></div>';
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: `Generate a 2-sentence call script for lead ${l.name} interested in ${l.course || 'courses'}. Context: ${l.notes || 'Inquiry'}` }] }] })
                });
                const res = await response.json();
                content.innerText = res.candidates?.[0]?.content?.parts?.[0]?.text || "AI Busy. Try later.";
            } catch(e) { content.innerText = "Check Connection."; }
        };
        window.saveEmployee = async () => {
            const n = document.getElementById('staff-name').value, i = document.getElementById('staff-id').value, p = document.getElementById('staff-pass').value;
            if(!n || !i || !p) return;
            await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'users', i), { name: n, password: p, role: 'telecaller' });
            closeStaffModal(); notify("Staff Created");
        };

        initAuth();
        let renderTimeout = null;
    </script>
</body>
</html>